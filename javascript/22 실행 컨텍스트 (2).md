# 22. 실행 컨텍스트 (2)

## ✔️ 실행 컨텍스트 생성 및 식별자 검색 과정

전역 코드 평가 이전에 **전역 객체가 생성**된다. 이후 **전역 코드**, **함수 코드**, **중첩 함수 코드**의 평가 > 실행 > 종료 순서로 진행된다. 

<aside>
▶️ 전역 코드 평가 > 전역 코드 실행 > { 함수 코드 평가 > 함수 코드 실행 > { 중첩 함수 코드 평가 > 중첩 함수 코드 실행 > 중첩 함수 코드 종료 } > 함수 코드 종료 } > 전역 코드 종료

</aside>

기본적으로 소스 코드가 평가 시, **환경 레코드가 생성**과 **외부 렉시컬 환경에 대한 참조가 결정**됩니다. 

### { ∙전역 코드 평가

소스코드가 평가되면서 **전역** **실행 컨텍스트가 생성** → **실행 컨텍스트 스택에 푸시** → **전역 렉시컬 환경이 생성**된다. 

이때 **¹전역 환경 레코드(렉시컬 환경을 구성하는 컴포넌트)**와 **²외부 렉시컬 환경**이라는 2개의 컴포넌트에 대한 참조로 구성된다.

- **전역** **환경 레코드**

**⑴ 객체 환경 레코드**에는 `var`로 선언된 전역 변수나, 전역 함수, 선언과 초기화가 동시에 진행되어 선언 이전에도 참조가 가능한(변수 호이스팅) 것들로 구성.

**⑵ 선언적 환경 레코드**에는 `let`, `const`로 선언된 변수나 블록 레벨 스코프, 선언 이전 접근이 불가능한 것들로 구성.

**⑶ `this`바인딩**의 경우 전역 환경 레코드에서만 존재하며 **전역 객체**를 가리킨다.

- **외부 렉시컬 환경에 대한 참조**

자신이 최상위 스코프 자체이기 때문에 `null`이다.

### ∙전역 코드 실행

런타임 이후 소스코드가 실행시, **할당문이 실행되어 값이 할당**된다. 실행 컨텍스트 내부에 선언된 **식별자를 검색**하고, **스코프 체인을 통해 스코프를 검색**한다. 검색이 불가할 때 참조 에러를 발생시킨다. 

### { ∙함수 코드 평가

함수가 호출되면 코드 실행이 중단되고 함수 내부로 이동하여 함수 코드를 평가한다. **함수 실행 컨텍스트가 생성 → 렉시컬 환경 생성 → 실행 컨텍스트 스택에 푸시된다.** 

이때 **¹함수 환경 레코드**와 **²렉시컬 환경**이 생성되어 컨텍스트에 바인딩 된다. 

- **함수 환경 레코드**

**⑴ 매개변수 객체**

**⑵ 함수 내부에 선언된 지역 변수, 중첩 함수**

**⑶ `this` 바인딩**은 **함수 환경 레코드의 내부 슬롯**에 바인딩 되거나, **일반함수의 경우 전역 객체**를 가리킨다. 

- **외부 렉시컬 환경에 대한 참조**

함수 정의가 평가된 시점인 **전역 실행 컨텍스트에서 실행 중인 실행 컨텍스트**의 렉시컬 환경의 참조가 할당된다. ⇒ 함수 호출이 아닌 **정의되고 평가된 시점에서 상위 스코프가 결정**된다는 것이다.  

### ∙함수 코드 실행

**매개변수에 인수가 할당**되고, **지역 변수에 값이 할당**된다. 중첩 함수가 호출되며 실행 중인 실행 컨텍스트에서 식별자를 검색한다. 

### { ∙중첩 함수 코드 평가

중첩 함수 호출시 코드 실행이 중단되고 내부 함수로 이동하여 중첩 함수 코드를 평가한다. **중첩 함수 실행 컨텍스트, 렉시컬 환경이 생성 → 실행 컨텍스트 스택에 푸시.** 

**¹중첩 함수 환경 레코드**와 **²외부 렉시컬 환경에 대한 참조**로 구성된다. 

### ∙중첩 함수 코드 실행

소스 코드가 실행되어 **매개변수와 지역변수에 값이 할당**된다.

`console.log`

`console`이라는 식별자를 렉시컬 환경에서 검색 → `log`라는 메서드를 검색 → 전달된 인수의 식별자를 검색하여 표현식 평가 후 **값을 생성**하게 되면 **해당 값을 console.log 메서드에 전달** → **호출을 완료** 

### ∙중첩 함수 코드 종료 }

실행 종료 후 **실행 컨텍스트 스택에 팝 되어 제거**된다. 단, **누군가 참조하고 있다면 소멸되지 않는다.** 

### ∙함수 코드 종료 }

실행 종료 후 실행 **컨텍스트 스택에 팝 되어 제거**된다. 실행 중인 실행 컨텍스트가 된다. 

### ∙전역 코드 종료 }

실행 종료 후 **실행 컨텍스트 스택에 팝 되어 제거**된다. 

## ✔️ 실행 컨텍스트와 블록 레벨 스코프

블록 레벨 스코프는 `let`, `const`로 선언된 변수가 생성한다. 기존 전역 환경 레코드에서 **선언적 환경 레코드를 갖는 렉시컬 환경**을 생성하며 교체한다.

블록문 실행 이전과 종료 후 전역 렉시컬 환경을 가리켰다가 되돌린다.